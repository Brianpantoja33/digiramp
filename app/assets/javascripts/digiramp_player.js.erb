
soundManager.setup({
  // disable or enable debug output
  debugMode: false,
  // use HTML5 audio for MP3/MP4, if available
  preferFlash: false,
  useFlashBlock: true,
  // path to directory containing SM2 SWF
  url: '../../swf/',
  // optional: enable MPEG-4/AAC support (requires flash 9)
  flashVersion: 9
});

soundManager.onready(function() {


  if ($('#digiramp_player')[0]) {

    // show the play-button
    $('#play-button').css("visibility", "visible");

    // set playhead height
    $('.playhead').css("height", $('.waveform').height());

    // set the duration
    var duration = convertTimeToString($(".duration").html())
    $(".duration").text(duration);

    // the sound
    var mySound = soundManager.createSound({
      id: 'aSound',
      url: $('#digiramp_player').attr('class'),
    });


    // progress bar
    mySound.load({
      whileloading: function() {
        var loaded = (this.bytesLoaded / this.bytesTotal) * 100;
        pos_om_pct = loaded.toString();
        var pos = parseInt(pos_om_pct, 10)
        pos += '%';
        $('.progress-bar.load-position').css("width", pos);
        $('.progress-bar.load-position').html(pos);
      }
    });

    // palybutton toogle
    var playing = false;
    var durationEstimate = 100;
    $("#play-button").click(function() {
      playing = !playing;
      // play
      if (playing) {
        mySound.play({
          whileplaying: function() {
            durationEstimate = this.durationEstimate
            playhead_pos = this.position / this.durationEstimate;
            pos = playhead_pos * waveform_width;

            var waveform_width = $('.waveform').width();

            //$('.playhead').css("margin-left", playhead_pos * waveform_width);
            
            $( ".playhead" ).animate({
                marginLeft: playhead_pos * waveform_width,
            
              }, 250 );
            $('.playhead').css("height", $('.waveform').height());
            
            
            $('.playhead').css("height", $('.waveform').height());

            $(".duration").text(convertTimeToString(this.position * 0.001));

          }
        });
      } else {
        // stop
        mySound.pause();
      }
    });

    // detect mouse down
    $(".waveform").click(function(event) {
      var offset = $(".waveform").offset();
      gotoSoundPosition = positionInPercent(event.pageX - offset.left);
      mySound.setPosition(durationEstimate * gotoSoundPosition);
    });
  };
});

function convertTimeToString(timeFloat) {
  var hours = parseInt(timeFloat / 3600);
  var minutes = parseInt(timeFloat / 60) - hours
  var seconds = parseInt(timeFloat) - (minutes * 60)
  var msec = parseInt(timeFloat * 100) - (parseInt(timeFloat) * 100)
  var timeString = convertToTwoDigitString(hours) + ':' + convertToTwoDigitString(minutes) + ':' + convertToTwoDigitString(seconds) + ':' + convertToTwoDigitString(msec)
  return (timeString);
}

function convertToTwoDigitString(inInt) {
  if (inInt < 10) {
    return ("0" + parseInt(inInt));
  }
  return (inInt);
}

function positionInPercent(mousePosX) {
  return(mousePosX/$(".waveform").width());
}
